<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Developer Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body data-page="insights">
<!-- Include the Navbar -->
<header th:replace="fragments/Navbar.html :: body"></header>

<main class="container mt-4">
  <div layout:fragment="content">
    <!-- Default content placeholder -->
    <div class="text-center">
      <h1>Welcome to the Developer Tool!</h1>
      <p class="text-muted">Your one-stop solution for code analysis and documentation.</p>
    </div>
  </div>
</main>

<!-- Include the Footer -->
<footer th:replace="fragments/Footer.html :: body"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  console.log('Base script is loaded');

  // Dropdown filter logic for insights.html
  function filterIssues(selectedType) {
    const url = selectedType ? `/sonar/issues?filterType=${encodeURIComponent(selectedType)}` : '/sonar/issues';
    window.location.href = url; // Reload the page with the selected filter
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Get the current page name from the data-page attribute
    const currentPage = document.body.getAttribute('data-page');

    // Check if the current page is 'insights'
    if (currentPage === 'insights') {
      console.log('Insights-specific script is running');

      // Attach event listener to the dropdown (if present)
      const issueTypeFilter = document.getElementById('issueTypeFilter');
      if (issueTypeFilter) {
        issueTypeFilter.addEventListener('change', function () {
          filterIssues(this.value);
        });
      }

      // Logic for "Apply Fix" buttons
      const fixButtons = document.querySelectorAll('button.apply-fix');
      fixButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const className = this.getAttribute('data-category');
          const description = this.getAttribute('data-description');
          applyFix(this, className, description);
        });
      });

      function applyFix(linkElement, className, description) {
        const url = `/sonar/issue/apply-fix/${encodeURIComponent(className)}/desc/${encodeURIComponent(description)}`;
        linkElement.textContent = 'Processing...';
        linkElement.style.pointerEvents = 'none';

        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        })
          .then(response => {
            if (response.ok) return response.json();
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          })
          .then(data => {
            alert('Fix applied successfully. Operation ID: ' + data.operationId);
            linkElement.textContent = 'Fix Applied';
            linkElement.style.color = 'green';
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error applying fix: ' + error.message);
            linkElement.textContent = 'Apply Fix';
            linkElement.style.pointerEvents = 'auto';
          });
      }
    }
  });
</script>
</body>
</html>