<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevGenie</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body data-page="insights">
<!-- Include the Navbar -->
<header th:replace="fragments/Navbar.html :: body"></header>

<main class="container mt-4">
  <div layout:fragment="content">
    <!-- Default content placeholder -->
    <div class="text-center">
      <h1>Welcome to the Developer Tool!</h1>
      <p class="text-muted">Your one-stop solution for code analysis and documentation.</p>
    </div>
  </div>
</main>

<!-- Modal -->
<div id="progressModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div id="progressModalContent" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
    <div id="progressBar" style="width: 0%; height: 30px; background-color: #4CAF50; text-align: center; line-height: 30px; color: white;"></div>
    <div id="progressText" style="margin-top: 20px; white-space: pre-line;">Request sent to application...</div>
  </div>
</div>

<!-- Include the Footer -->
<footer th:replace="fragments/Footer.html :: body"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  console.log('Base script is loaded');

  // Dropdown filter logic for insights.html
  function filterIssues(selectedType) {
      const url = selectedType ? '/sonar/issues?filterType=' + encodeURIComponent(selectedType) : '/sonar/issues';
      window.location.href = url; // Reload the page with the selected filter
  }

  document.addEventListener('DOMContentLoaded', function () {
      // Get the current page name from the data-page attribute
      const currentPage = document.body.getAttribute('data-page');

      // Check if the current page is 'insights'
      if (currentPage === 'insights') {
          console.log('Insights-specific script is running');

          // Attach event listener to the dropdown (if present)
          const issueTypeFilter = document.getElementById('issueTypeFilter');
          if (issueTypeFilter) {
              issueTypeFilter.addEventListener('change', function () {
                  filterIssues(this.value);
              });
          }

          // Logic for "Apply Fix" buttons
          const fixButtons = document.querySelectorAll('button.apply-fix');
          fixButtons.forEach(button => {
              button.addEventListener('click', function (event) {
                  event.preventDefault();
                  const className = this.getAttribute('data-category');
                  const description = this.getAttribute('data-description');
                  applyFix(this, className, description);
              });
          });

          // Logic for "Fix More" button
          const fixMoreButton = document.getElementById('fixMoreButton');
          const checkboxes = document.querySelectorAll('.issue-checkbox');

          checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', toggleFixMoreButton);
          });

          function toggleFixMoreButton() {
              const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
              fixMoreButton.style.display = selectedCheckboxes.length > 1 ? 'block' : 'none';
          }

          fixMoreButton.addEventListener('click', applyFixMore);

          function applyFixMore() {
              const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
              const classDescriptions = selectedCheckboxes.map(checkbox => ({
                  className: checkbox.getAttribute('data-category'),
                  description: checkbox.getAttribute('data-description')
              }));

              // Modal elements
              const modal = document.getElementById('progressModal');
              const modalContent = document.getElementById('progressModalContent');
              const progressBar = document.getElementById('progressBar');
              const progressText = document.getElementById('progressText');

              // Create close button
              const closeButton = document.createElement('span');
              closeButton.innerHTML = '&times;';
              closeButton.style.cssText = 'position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;';
              closeButton.onclick = () => {
                modal.style.display = 'none';
              };
              modalContent.insertBefore(closeButton, modalContent.firstChild);

              // Show modal and reset progress
              modal.style.display = 'block';
              progressBar.style.width = '0%';
              progressText.textContent = 'Request getting Processed...\n';

              let displayedEvents = new Set();

              const updateProgressText = (events) => {
                  events.forEach(event => {
                      if (!displayedEvents.has(event)) {
                          progressText.textContent += event + '\n';
                          displayedEvents.add(event);
                      }
                  });
              };

              fetch('/sonar/issue/apply-fix', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(classDescriptions)
              })
              .then(response => response.json())
              .then(data => {
                  if (!data.operationId) {
                      throw new Error('operationId not found.');
                  }
                  const operationId = data.operationId;
                  let progress = 0;
                  const interval = setInterval(() => {
                      fetch('/sonar/issue/fix-status/' + operationId)
                          .then(response => {
                              if (response.ok) return response.json();
                              throw new Error('Error ' + response.status + ': ' + response.statusText);
                          })
                          .then(statusData => {
                              const events = statusData.step;
                              updateProgressText(events);
                              progress += 16;
                              progressBar.style.width = Math.min(progress, 100) + '%';
                              if (events.some(event => event.includes('Completed'))) {
                                  clearInterval(interval);
                                  updateProgressText(['Fix applied successfully!']);
                              }
                              if (events.some(event => event.includes("Failed"))) {
                                  clearInterval(interval);
                                  updateProgressText(["There was an error applying the fix."]);
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              updateProgressText(['Error: ' + error.message]);
                              clearInterval(interval);
                          });
                  }, 250); // Reduced interval to 250ms
              })
              .catch(error => {
                  console.error('Error:', error);
                  updateProgressText(['Error: ' + error.message]);
              });
          }

          function applyFix(linkElement, className, description) {
              const url = '/sonar/issue/apply-fix/' + encodeURIComponent(className) + '/desc/' + encodeURIComponent(description);

              // Modal elements
              const modal = document.getElementById('progressModal');
              const modalContent = document.getElementById('progressModalContent');
              const progressBar = document.getElementById('progressBar');
              const progressText = document.getElementById('progressText');

              // Create close button
              const closeButton = document.createElement('span');
              closeButton.innerHTML = '&times;';
              closeButton.style.cssText = 'position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;';
              closeButton.onclick = () => {
                modal.style.display = 'none';
              };
              modalContent.insertBefore(closeButton, modalContent.firstChild);

              // Show modal and reset progress
              modal.style.display = 'block';
              progressBar.style.width = '0%';
              progressText.textContent = 'Starting...\n';

              let displayedEvents = new Set();

              const updateProgressText = (events) => {
                  events.forEach(event => {
                      if (!displayedEvents.has(event)) {
                          progressText.textContent += event + '\n';
                          displayedEvents.add(event);
                      }
                  });
              };

              linkElement.textContent = 'Processing...';
              linkElement.style.pointerEvents = 'none';

              fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
              })
                  .then(response => {
                      if (response.ok) return response.json();
                      throw new Error('Error ' + response.status + ': ' + response.statusText);
                  })
                  .then(data => {
                      if (!data.operationId) {
                          throw new Error('operationId not found.');
                      }
                      const operationId = data.operationId;
                      let progress = 0;
                      const interval = setInterval(() => {
                          fetch('/sonar/issue/fix-status/' + operationId)
                              .then(response => {
                                  if (response.ok) return response.json();
                                  throw new Error('Error ' + response.status + ': ' + response.statusText);
                              })
                              .then(statusData => {
                                  const events = statusData.step;
                                  updateProgressText(events);
                                  progress += 16;
                                  progressBar.style.width = Math.min(progress, 100) + '%';
                                  if (events.some(event => event.includes('Completed'))) {
                                      clearInterval(interval);
                                      linkElement.textContent = 'Fix Applied';
                                      linkElement.style.color = 'green';
                                  }
                                  if (events.some(event => event.includes("Failed"))) {
                                      clearInterval(interval);
                                      updateProgressText(["There was an error applying the fix."]);
                                      linkElement.textContent = 'Error Applying Fix';
                                      linkElement.style.color = 'red';
                                  }
                              })
                              .catch(error => {
                                  console.error('Error:', error);
                                  updateProgressText(['Error: ' + error.message]);
                                  clearInterval(interval);
                                  linkElement.textContent = 'Apply Fix';
                                  linkElement.style.pointerEvents = 'auto';
                              });
                      }, 250); // Reduced interval to 100ms
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      updateProgressText(['Error: ' + error.message]);
                      linkElement.textContent = 'Apply Fix';
                      linkElement.style.pointerEvents = 'auto';
                  });
          }
      }
  });
</script>
</body>
</html>