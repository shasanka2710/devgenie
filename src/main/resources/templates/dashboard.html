<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title>Dashboard</title>
    <style>
        :root {
            --wf-red: #d71921;
            --wf-red-dark: #b71c1c;
            --wf-red-light: #ffebee;
            --wf-blue: #1976d2;
            --wf-green: #388e3c;
            --wf-yellow: #f57c00;
            --wf-gray: #f5f5f5;
            --wf-dark-gray: #424242;
            --wf-light-gray: #fafafa;
            --wf-border: #e0e0e0;
        }

        body {
            background-color: var(--wf-light-gray);
            color: var(--wf-dark-gray);
        }

        .card {
            border: 1px solid var(--wf-border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid var(--wf-border);
            font-weight: 600;
            color: var(--wf-dark-gray);
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--wf-border);
        }

        .avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--wf-border);
        }

        /* Metrics Cards with RBGY Colors */
        .metric-red {
            background: linear-gradient(135deg, var(--wf-red) 0%, var(--wf-red-dark) 100%);
            color: white;
            border: none;
        }

        .metric-blue {
            background: linear-gradient(135deg, var(--wf-blue) 0%, #1565c0 100%);
            color: white;
            border: none;
        }

        .metric-green {
            background: linear-gradient(135deg, var(--wf-green) 0%, #2e7d32 100%);
            color: white;
            border: none;
        }

        .metric-yellow {
            background: linear-gradient(135deg, var(--wf-yellow) 0%, #ef6c00 100%);
            color: white;
            border: none;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--wf-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .main-content {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--wf-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .org-selector {
            border: 1px solid var(--wf-border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .org-selector:focus {
            border-color: var(--wf-red);
            box-shadow: 0 0 0 0.2rem rgba(215, 25, 33, 0.15);
        }

        .org-item {
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .org-item:hover {
            background-color: var(--wf-gray);
            border-color: var(--wf-border);
        }

        .org-item.active {
            background-color: var(--wf-red-light);
            border-color: var(--wf-red);
        }

        .org-item-compact {
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .org-item-compact:hover {
            background-color: var(--wf-gray);
            border-color: var(--wf-border);
        }

        .org-item-compact.active {
            background-color: var(--wf-red-light);
            border-color: var(--wf-red);
        }

        .organization-dropdown .org-selector {
            background-color: white;
            border: 2px solid var(--wf-border);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .organization-dropdown .org-selector:focus {
            border-color: var(--wf-red);
            box-shadow: 0 0 0 0.2rem rgba(215, 25, 33, 0.15);
        }

        .search-container {
            position: relative;
        }

        .search-suggestions {
            background: white;
            border: 1px solid var(--wf-border);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .suggestion-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--wf-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: var(--wf-gray);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .analyzed-repos .repo-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--wf-border);
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .analyzed-repos .repo-item:hover {
            background-color: var(--wf-gray);
        }

        .coverage-grade {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .coverage-grade.A { background-color: var(--wf-green); color: white; }
        .coverage-grade.B { background-color: #4caf50; color: white; }
        .coverage-grade.C { background-color: var(--wf-yellow); color: white; }
        .coverage-grade.D { background-color: #ff9800; color: white; }
        .coverage-grade.F { background-color: var(--wf-red); color: white; }

        .section-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--wf-dark-gray);
            border-bottom: 1px solid var(--wf-border);
            padding-bottom: 0.5rem;
        }

        .suggestion-header {
            background-color: #f8f9fa !important;
            border-bottom: 1px solid var(--wf-border) !important;
            font-weight: 600;
        }

        .repository-card {
            transition: opacity 0.2s ease;
        }

        .repository-card[style*="display: none"] {
            display: none !important;
        }

        .search-container input:focus {
            border-color: var(--wf-red);
            box-shadow: 0 0 0 0.2rem rgba(215, 25, 33, 0.15);
        }

        .form-select:focus {
            border-color: var(--wf-red);
            box-shadow: 0 0 0 0.2rem rgba(215, 25, 33, 0.15);
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- User Profile Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <img th:src="${user.avatarUrl}" class="avatar-lg" alt="Avatar" th:if="${user.avatarUrl}">
                        </div>
                        <div class="col">
                            <h3 class="mb-1" th:text="${user.name ?: user.login}" style="color: var(--wf-dark-gray);">User Name</h3>
                            <p class="text-muted mb-1" th:text="${user.email}" th:if="${user.email}">user@example.com</p>
                            <p class="text-muted mb-0">
                                <i class="bi bi-github me-1"></i>
                                <a th:href="${user.htmlUrl}" target="_blank" th:text="${user.login}" class="text-decoration-none" style="color: var(--wf-red);">username</a>
                            </p>
                        </div>
                        <div class="col-auto">
                            <div class="row g-3 text-center">
                                <div class="col">
                                    <div class="card metric-red">
                                        <div class="card-body py-3 px-4">
                                            <div class="metric-value" th:text="${totalRepos}">0</div>
                                            <div class="metric-label">Total Repos</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card metric-blue">
                                        <div class="card-body py-3 px-4">
                                            <div class="metric-value" th:text="${javaReposCount}">0</div>
                                            <div class="metric-label">Java Repos</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card metric-green">
                                        <div class="card-body py-3 px-4">
                                            <div class="metric-value" th:text="${organizations.size()}">0</div>
                                            <div class="metric-label">Organizations</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Enhanced Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="sidebar p-3">
                <!-- Organizations Section -->
                <h5 class="section-header">
                    <i class="bi bi-building me-2"></i>
                    Organizations
                    <span class="badge bg-secondary ms-2" th:text="${organizations.size()}">0</span>
                </h5>

                <!-- Show dropdown for multiple organizations (enterprise scenario) -->
                <div th:if="${organizations.size() > 3}" class="organization-dropdown mb-4">
                    <select class="form-select org-selector mb-3" id="organizationSelect" onchange="loadOrgRepositories()">
                        <option value="personal">📁 Personal Repositories</option>
                        <option th:each="org : ${organizations}" 
                                th:value="${org.login}" 
                                th:text="'🏢 ' + ${org.name ?: org.login}">
                            Organization Name
                        </option>
                    </select>
                    
                    <!-- Quick access to most recent organizations -->
                    <div class="mt-2">
                        <small class="text-muted d-block mb-2">
                            <i class="bi bi-clock me-1"></i>Recent Organizations
                        </small>
                        <div th:each="org, iterStat : ${organizations}" 
                             th:if="${iterStat.index < 3}"
                             class="org-item-compact mb-1 p-1 rounded" 
                             th:onclick="'loadRepositories(\'' + ${org.login} + '\')'" 
                             style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <img th:if="${org.avatarUrl}" th:src="${org.avatarUrl}" class="rounded me-2" width="20" height="20" alt="Org Avatar">
                                <i th:unless="${org.avatarUrl}" class="bi bi-building me-2"></i>
                                <div class="flex-grow-1">
                                    <small class="fw-semibold" th:text="${org.name ?: org.login}">Org Name</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Show individual org items for few organizations (regular scenario) -->
                <div th:unless="${organizations.size() > 3}" class="organization-list mb-4">
                    <!-- Personal Repositories -->
                    <div class="org-item mb-2 p-2 rounded" onclick="loadRepositories('personal')" style="cursor: pointer;">
                        <div class="d-flex align-items-center">
                            <div class="org-avatar me-2">
                                <i class="bi bi-person-circle fs-4"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Personal</div>
                                <small class="text-muted">Your repositories</small>
                            </div>
                        </div>
                    </div>

                    <!-- Organization Items -->
                    <div th:each="org : ${organizations}" class="org-item mb-2 p-2 rounded" 
                         th:onclick="'loadRepositories(\'' + ${org.login} + '\')'" style="cursor: pointer;">
                        <div class="d-flex align-items-center">
                            <div class="org-avatar me-2">
                                <img th:if="${org.avatarUrl}" th:src="${org.avatarUrl}" class="rounded" width="24" height="24" alt="Org Avatar">
                                <i th:unless="${org.avatarUrl}" class="bi bi-building fs-4"></i>
                            </div>
                            <div>
                                <div class="fw-semibold" th:text="${org.name ?: org.login}">Organization Name</div>
                                <small class="text-muted" th:text="${org.login}">@username</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repository Search -->
                <h5 class="section-header">
                    <i class="bi bi-search me-2"></i>
                    Search Repositories
                </h5>
                <div class="search-container mb-4">
                    <div class="position-relative">
                        <input type="text" class="form-control" id="repositorySearchInput" 
                               placeholder="Search repositories..." autocomplete="off">
                        <div id="searchSuggestions" class="search-suggestions position-absolute w-100" 
                             style="z-index: 1000; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; display: none;">
                        </div>
                    </div>
                </div>

                <!-- Recently Analyzed Repositories -->
                <h5 class="section-header">
                    <i class="bi bi-clock-history me-2"></i>
                    Recently Analyzed
                </h5>
                <div id="analyzedRepositories" class="analyzed-repos">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="d-block mt-2 text-muted">Loading analyzed repositories...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <div class="main-content p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="section-header mb-0">
                        <i class="bi bi-folder me-2"></i>
                        <span id="repositoryTitle">All Repositories</span>
                    </h4>
                    <div class="d-flex align-items-center gap-3">
                        <!-- Repository Filter -->
                        <select class="form-select form-select-sm" id="languageFilter" onchange="filterRepositories()" style="width: auto;">
                            <option value="">All Languages</option>
                            <option value="Java">Java</option>
                            <option value="JavaScript">JavaScript</option>
                            <option value="Python">Python</option>
                            <option value="TypeScript">TypeScript</option>
                            <option value="Go">Go</option>
                            <option value="C++">C++</option>
                        </select>
                        
                        <div class="card metric-yellow">
                            <div class="card-body py-2 px-3">
                                <span class="fw-bold" id="repoCount" th:text="${allRepositories != null ? allRepositories.size() : (javaRepositories != null ? javaRepositories.size() : '0')}">0</span>
                                <small class="ms-1">repositories</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repository List -->
                <div id="repositoryList">
                    <!-- Show all repositories if available, otherwise show Java repositories, otherwise show empty state -->
                    <div th:if="${(allRepositories != null and allRepositories.empty) or (allRepositories == null and javaRepositories.empty)}" class="empty-state">
                        <i class="bi bi-folder-x"></i>
                        <h5 class="mt-3">No repositories found</h5>
                        <p>Click on an organization in the sidebar to load its repositories, or check if you have access to repositories in your account.</p>
                    </div>

                    <!-- Repository cards for all repositories -->
                    <div th:unless="${(allRepositories != null and allRepositories.empty) or (allRepositories == null and javaRepositories.empty)}" class="row" id="repositoryCards">
                        <!-- Use allRepositories if available, otherwise use javaRepositories -->
                        <div th:each="repo : ${allRepositories != null ? allRepositories : javaRepositories}" 
                             class="col-12 mb-3 repository-card" 
                             th:data-language="${repo.language ?: 'Unknown'}"
                             th:data-name="${repo.name}"
                             th:data-description="${repo.description ?: ''}"
                             th:data-fullname="${repo.fullName}">
                            <div class="card repo-card">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h5 class="card-title mb-1">
                                                <i class="bi bi-folder-fill me-2 text-primary"></i>
                                                <span th:text="${repo.name}">Repository Name</span>
                                                <span th:class="'badge ms-2 ' + ${repo.visibilityBadgeClass}" th:text="${repo.visibilityBadge}">Public</span>
                                            </h5>
                                            <p class="card-text text-muted mb-2" th:text="${repo.description}" th:if="${repo.description}">
                                                Repository description
                                            </p>
                                            <div class="d-flex align-items-center text-sm text-muted">
                                                <span class="me-3" th:if="${repo.language}">
                                                    <i class="bi bi-circle-fill me-1" style="color: #f89820;"></i>
                                                    <span th:text="${repo.language}">Java</span>
                                                </span>
                                                <span class="me-3" th:if="${repo.stargazersCount}">
                                                    <i class="bi bi-star me-1"></i>
                                                    <span th:text="${repo.stargazersCount}">0</span>
                                                </span>
                                                <span class="me-3" th:if="${repo.forksCount}">
                                                    <i class="bi bi-diagram-3 me-1"></i>
                                                    <span th:text="${repo.forksCount}">0</span>
                                                </span>
                                                <span th:if="${repo.updatedAt}">
                                                    <i class="bi bi-clock me-1"></i>
                                                    Updated <span th:text="${#temporals.format(#temporals.createNow(), 'MMM dd, yyyy')}">Recently</span>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <a th:href="@{/coverage/repository/{owner}/{repo}(owner=${repo.owner.login}, repo=${repo.name})}"
                                               class="btn btn-primary">
                                                <i class="bi bi-lightbulb me-2"></i>
                                                View Repository
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<th:block layout:fragment="scripts">
    <script>
        let currentOrg = '';
        let searchTimeout;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyzedRepositories();
            setupRepositorySearch();
            
            // Auto-select Personal repositories by default
            const personalOrgItem = document.querySelector('.org-item[onclick*="personal"], .org-item-compact[onclick*="personal"]');
            if (personalOrgItem) {
                personalOrgItem.classList.add('active');
            }
            
            // Also set dropdown to personal if it exists
            const orgSelect = document.getElementById('organizationSelect');
            if (orgSelect) {
                orgSelect.value = 'personal';
            }
            
            currentOrg = 'personal';
        });

        // Load repositories for selected organization
        function loadRepositories(orgName) {
            currentOrg = orgName;
            
            // Update active state in sidebar for individual org items
            document.querySelectorAll('.org-item, .org-item-compact').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked item
            if (event && event.target) {
                const clickedItem = event.target.closest('.org-item, .org-item-compact');
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
            }
            
            // Also update dropdown selection if it exists
            const orgSelect = document.getElementById('organizationSelect');
            if (orgSelect) {
                orgSelect.value = orgName;
            }

            // Clear search when switching organizations
            const searchInput = document.getElementById('repositorySearchInput');
            searchInput.value = '';
            hideSuggestions();

            // Show loading
            showLoading('repositoryList');

            // Update title
            const displayName = orgName === 'personal' ? 'Personal' : orgName;
            document.getElementById('repositoryTitle').textContent = `${displayName} Repositories`;

            // Determine URL based on organization
            const url = orgName === 'personal' ? '/' : `/organization?org=${orgName}`;
            
            // Fetch repositories
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract just the repository cards from the response
                    const newRepositoryList = tempDiv.querySelector('#repositoryList');
                    if (newRepositoryList) {
                        document.getElementById('repositoryList').innerHTML = newRepositoryList.innerHTML;
                        
                        // Update repository count
                        const cards = document.querySelectorAll('.repository-card');
                        document.getElementById('repoCount').textContent = cards.length;
                    } else {
                        document.getElementById('repositoryList').innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error loading repositories:', error);
                    document.getElementById('repositoryList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load repositories for ${displayName}
                        </div>
                    `;
                });
        }

        // Handle dropdown selection (for enterprise scenarios with many orgs)
        function loadOrgRepositories() {
            const select = document.getElementById('organizationSelect');
            if (select && select.value) {
                const selectedOrg = select.value;
                currentOrg = selectedOrg;
                
                // Clear active state from individual org items
                document.querySelectorAll('.org-item, .org-item-compact').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Call the main loadRepositories function
                loadRepositoriesWithoutEvent(selectedOrg);
            }
        }

        // Load repositories without relying on event object (for dropdown calls)
        function loadRepositoriesWithoutEvent(orgName) {
            currentOrg = orgName;
            
            // Clear search when switching organizations
            const searchInput = document.getElementById('repositorySearchInput');
            searchInput.value = '';
            hideSuggestions();

            // Show loading
            showLoading('repositoryList');

            // Update title
            const displayName = orgName === 'personal' ? 'Personal' : orgName;
            document.getElementById('repositoryTitle').textContent = `${displayName} Repositories`;

            // Determine URL based on organization
            const url = orgName === 'personal' ? '/' : `/organization?org=${orgName}`;
            
            // Fetch repositories
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract just the repository cards from the response
                    const newRepositoryList = tempDiv.querySelector('#repositoryList');
                    if (newRepositoryList) {
                        document.getElementById('repositoryList').innerHTML = newRepositoryList.innerHTML;
                        
                        // Update repository count
                        const cards = document.querySelectorAll('.repository-card');
                        document.getElementById('repoCount').textContent = cards.length;
                    } else {
                        document.getElementById('repositoryList').innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error loading repositories:', error);
                    document.getElementById('repositoryList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load repositories for ${displayName}
                        </div>
                    `;
                });
        }

        // Setup repository search with autosuggest
        function setupRepositorySearch() {
            const searchInput = document.getElementById('repositorySearchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');

            if (!searchInput) {
                console.warn('Repository search input not found');
                return;
            }

            if (!suggestionsContainer) {
                console.warn('Search suggestions container not found');
                return;
            }

            searchInput.addEventListener('input', function() {
                try {
                    const query = this.value.trim();
                    
                    // Clear previous timeout
                    clearTimeout(searchTimeout);
                    
                    if (query.length === 0) {
                        hideSuggestions();
                        showAllRepositories();
                        return;
                    }

                    // For short queries, do local search
                    if (query.length < 3) {
                        hideSuggestions();
                        filterLocalRepositories(query);
                        return;
                    }

                    // For longer queries, show both local results and API suggestions
                    filterLocalRepositories(query);
                    
                    // Debounce API search requests
                    searchTimeout = setTimeout(() => {
                        searchRepositoriesAPI(query);
                    }, 300);
                } catch (error) {
                    console.error('Error in search input handler:', error);
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    hideSuggestions();
                }
            });
        }

        // Filter repositories locally (in the current view)
        function filterLocalRepositories(query) {
            try {
                const repositoryCards = document.querySelectorAll('.repository-card');
                const lowerQuery = query.toLowerCase();
                let visibleCount = 0;

                console.log(`Filtering ${repositoryCards.length} repository cards with query: "${query}"`);

                repositoryCards.forEach((card, index) => {
                    try {
                        // Safely get attributes with null checks
                        const name = (card.getAttribute('data-name') || '').toLowerCase();
                        const description = (card.getAttribute('data-description') || '').toLowerCase();
                        const fullName = (card.getAttribute('data-fullname') || '').toLowerCase();
                        
                        const matches = name.includes(lowerQuery) || 
                                      description.includes(lowerQuery) || 
                                      fullName.includes(lowerQuery);
                        
                        if (matches) {
                            card.style.display = 'block';
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                        }
                    } catch (cardError) {
                        console.error(`Error processing repository card ${index}:`, cardError, card);
                        // Keep card visible if there's an error processing it
                        card.style.display = 'block';
                        visibleCount++;
                    }
                });

                // Update repository count
                const repoCountElement = document.getElementById('repoCount');
                if (repoCountElement) {
                    repoCountElement.textContent = visibleCount;
                }
                
                // Update title to show search results
                const titleElement = document.getElementById('repositoryTitle');
                if (titleElement) {
                    if (query.length > 0) {
                        titleElement.textContent = `Search Results for "${query}"`;
                    } else {
                        titleElement.textContent = currentOrg ? `${currentOrg} Repositories` : 'All Repositories';
                    }
                }

                console.log(`Filter complete. Showing ${visibleCount} repositories.`);
            } catch (error) {
                console.error('Error in filterLocalRepositories:', error);
            }
        }

        // Show all repositories (reset filter)
        function showAllRepositories() {
            const repositoryCards = document.querySelectorAll('.repository-card');
            repositoryCards.forEach(card => {
                card.style.display = 'block';
            });
            
            // Reset count
            const totalCount = repositoryCards.length;
            const repoCountElement = document.getElementById('repoCount');
            if (repoCountElement) {
                repoCountElement.textContent = totalCount;
            }
            
            // Reset title
            const titleElement = document.getElementById('repositoryTitle');
            if (titleElement) {
                titleElement.textContent = currentOrg ? `${currentOrg} Repositories` : 'All Repositories';
            }
        }

        // Filter repositories by language
        function filterRepositories() {
            const languageFilterElement = document.getElementById('languageFilter');
            const searchInput = document.getElementById('repositorySearchInput');
            
            if (!languageFilterElement || !searchInput) {
                console.warn('Required filter elements not found');
                return;
            }
            
            const languageFilter = languageFilterElement.value;
            const repositoryCards = document.querySelectorAll('.repository-card');
            let visibleCount = 0;

            repositoryCards.forEach(card => {
                // Safely get language attribute with null check
                const language = card.getAttribute('data-language') || '';
                const matchesLanguage = !languageFilter || language === languageFilter;
                
                // Also apply search filter if there's a search query
                const searchQuery = searchInput.value.trim().toLowerCase();
                let matchesSearch = true;
                
                if (searchQuery.length > 0) {
                    // Safely get attributes with null checks
                    const name = (card.getAttribute('data-name') || '').toLowerCase();
                    const description = (card.getAttribute('data-description') || '').toLowerCase();
                    const fullName = (card.getAttribute('data-fullname') || '').toLowerCase();
                    
                    matchesSearch = name.includes(searchQuery) || 
                                  description.includes(searchQuery) || 
                                  fullName.includes(searchQuery);
                }
                
                if (matchesLanguage && matchesSearch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Update count
            const repoCountElement = document.getElementById('repoCount');
            if (repoCountElement) {
                repoCountElement.textContent = visibleCount;
            }
        }

        // Search repositories using API (for autosuggest from other orgs)
        function searchRepositoriesAPI(query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            // Show loading in suggestions
            suggestionsContainer.innerHTML = `
                <div class="suggestion-item text-center">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <small class="ms-2">Searching other repositories...</small>
                </div>
            `;
            suggestionsContainer.style.display = 'block';

            // Make API call for autosuggest from other organizations
            const searchUrl = `/api/coverage/search-repositories?query=${encodeURIComponent(query)}&limit=5`;
            
            fetch(searchUrl)
                .then(response => response.json())
                .then(data => {
                    displaySearchSuggestions(data.repositories || [], query);
                })
                .catch(error => {
                    console.error('Error searching repositories:', error);
                    suggestionsContainer.innerHTML = `
                        <div class="suggestion-item text-muted text-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>API search not available</small>
                        </div>
                    `;
                });
        }

        // Display search suggestions
        function displaySearchSuggestions(repositories, searchQuery) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (repositories.length === 0) {
                suggestionsContainer.innerHTML = `
                    <div class="suggestion-item text-muted text-center">
                        <i class="bi bi-search me-2"></i>
                        <small>No additional repositories found</small>
                    </div>
                `;
                return;
            }

            // Add header for external suggestions
            let suggestionsHtml = `
                <div class="suggestion-header px-3 py-2 bg-light border-bottom">
                    <small class="text-muted fw-semibold">
                        <i class="bi bi-globe me-1"></i>
                        Other Available Repositories
                    </small>
                </div>
            `;

            suggestionsHtml += repositories.map(repo => `
                <div class="suggestion-item" onclick="selectRepository('${repo.fullName}', '${repo.htmlUrl}')">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-folder-fill me-2 text-primary"></i>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">${repo.name}</div>
                            <small class="text-muted">${repo.fullName}</small>
                        </div>
                        <span class="badge ${repo.isPrivate ? 'bg-danger' : 'bg-success'} ms-2">
                            ${repo.isPrivate ? 'Private' : 'Public'}
                        </span>
                    </div>
                </div>
            `).join('');

            suggestionsContainer.innerHTML = suggestionsHtml;
        }

        // Select repository from suggestions
        function selectRepository(fullName, htmlUrl) {
            const [owner, repo] = fullName.split('/');
            window.location.href = `/coverage/repository/${owner}/${repo}`;
        }

        // Hide search suggestions
        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
            }
        }

        // Load analyzed repositories
        function loadAnalyzedRepositories() {
            const container = document.getElementById('analyzedRepositories');
            
            fetch('/api/coverage/analyzed-repositories?limit=5')
                .then(response => response.json())
                .then(data => {
                    displayAnalyzedRepositories(data.repositories || []);
                })
                .catch(error => {
                    console.error('Error loading analyzed repositories:', error);
                    container.innerHTML = `
                        <div class="text-center py-3 text-muted">
                            <i class="bi bi-exclamation-circle"></i>
                            <small class="d-block">Failed to load analyzed repositories</small>
                        </div>
                    `;
                });
        }

        // Display analyzed repositories
        function displayAnalyzedRepositories(repositories) {
            const container = document.getElementById('analyzedRepositories');
            
            if (repositories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-clock-history"></i>
                        <small class="d-block mt-2">No analyzed repositories yet</small>
                    </div>
                `;
                return;
            }

            const reposHtml = repositories.map(repo => `
                <div class="repo-item" onclick="window.location.href='/coverage/repository/${repo.owner}/${repo.name}'">
                    <div class="coverage-grade ${repo.coverageGrade || 'F'}">${repo.coverageGrade || 'F'}</div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" style="font-size: 0.875rem;">${repo.name}</div>
                        <small class="text-muted">${repo.fullName}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = reposHtml;
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Loading repositories...</h5>
                </div>
            `;
        }
    </script>
</th:block>
</body>
</html>