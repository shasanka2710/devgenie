<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{base.html}">
<head>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* General Styles */
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f8f9fa;
        color: #333;
    }

    .section-header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ddd;
    }

    .section-header h3 {
        color: #333;
    }

    /* Search Bar */
    .search-container {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

    #searchInput {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
        flex-grow: 1;
    }

    #searchButton {
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Table Styles */
    .table-container {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }

    .table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
        background-color: #e9ecef;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .table td, .table th {
        padding: 1rem;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
    }

    .table-bordered {
        border: 1px solid #dee2e6;
    }

    .table-bordered td, .table-bordered th {
        border: 1px solid #dee2e6;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .apply-fix {
        transition: background-color 0.3s ease;
    }

    .apply-fix:hover {
        background-color: #0069d9;
    }

    .form-select {
        width: auto;
        display: inline-block;
    }

    .mb-3 {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .mb-3 {
            flex-direction: column;
            align-items: flex-start;
        }

        .form-select {
            width: 100%;
        }
    }

    /* Loading Indicator */
    .loading {
        display: none;
        text-align: center;
        margin-top: 20px;
    }

    .no-data {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #666;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="section-header">
    <h3>Sonar Issue for your project</h3>
  </div>

  <!-- Prompt Bar -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Enter your prompt...">
    <button id="searchButton">Submit</button>
  </div>

  <!-- Dropdown for filtering issues -->
  <div class="mb-3">
    <label for="issueTypeFilter" class="form-label">Filter by Issue Type:</label>
    <select id="issueTypeFilter" class="form-select" onchange="filterIssues(this.value)">
      <option value="">All</option>
      <option th:each="type : ${issueTypes}" th:value="${type}" th:text="${type}"
              th:selected="${selectedType == type}"></option>
    </select>
  </div>

  <!-- Fix More Button -->
  <div class="mb-3">
    <button id="fixMoreButton" class="btn btn-warning" style="display: none;" onclick="applyFixMore()">Fix More</button>
  </div>

  <!-- Loading Indicator -->
  <div class="loading" id="loadingIndicator">Loading...</div>

  <!-- Insights Table -->
  <div class="table-container">
    <table class="table table-bordered table-striped" id="issuesTable">
      <thead>
      <tr>
        <th>Select</th>
        <th>Issue Type</th>
        <th>Class Name</th>
        <th>Description</th>
        <th>Severity</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="issue : ${issues}">
        <td><input type="checkbox" class="issue-checkbox" th:data-category="${issue.category}" th:data-description="${issue.description}" onchange="toggleFixMoreButton()"></td>
        <td th:text="${issue.type}"></td>
        <td th:text="${issue.className}"></td>
        <td th:text="${issue.description}"></td>
        <td th:text="${issue.severity}"></td>
        <td>
          <button class="btn btn-primary btn-sm apply-fix"
                  th:data-category="${issue.category}"
                  th:data-description="${issue.description}">Apply Fix
          </button>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(issues)}">
        <td colspan="6">
          <div class="no-data">No data available</div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div id="paginationControls" class="d-flex justify-content-center mt-3">
    <!-- Pagination buttons will be dynamically added here -->
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');
      const table = document.getElementById('issuesTable');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const paginationControls = document.getElementById('paginationControls');
      const fixMoreButton = document.getElementById('fixMoreButton');
      const checkboxes = document.getElementsByClassName('issue-checkbox');

      function filterTable() {
          const searchTerm = searchInput.value.toLowerCase();
          for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              const cells = row.getElementsByTagName('td');
              let found = false;
              for (let j = 0; j < cells.length; j++) {
                  const cell = cells[j];
                  if (cell.textContent.toLowerCase().indexOf(searchTerm) > -1) {
                      found = true;
                      break;
                  }
              }
              row.style.display = found ? '' : 'none';
          }
      }

      function showLoadingIndicator(show) {
          loadingIndicator.style.display = show ? 'block' : 'none';
      }

      function paginateTable(page, rowsPerPage) {
          const displayedRows = Array.from(rows).filter(row => row.style.display !== 'none');
          const totalRows = displayedRows.length;
          const totalPages = Math.ceil(totalRows / rowsPerPage);
          paginationControls.innerHTML = '';

          // Hide all rows
          for (let i = 0; i < rows.length; i++) {
              rows[i].style.display = 'none';
          }

          // Display the selected page
          const start = (page - 1) * rowsPerPage;
          const end = start + rowsPerPage;
          for (let i = start; i < end && i < totalRows; i++) {
              const rowIndex = Array.from(rows).indexOf(displayedRows[i])
              rows[rowIndex].style.display = '';
          }

          // Add pagination buttons
          for (let i = 1; i <= totalPages; i++) {
              const button = document.createElement('button');
              button.textContent = i;
              button.className = 'btn btn-secondary mx-1';
              button.addEventListener('click', () => paginateTable(i, rowsPerPage));
              paginationControls.appendChild(button);
          }
      }

      function toggleFixMoreButton() {
          const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
          fixMoreButton.style.display = selectedCheckboxes.length > 1 ? 'block' : 'none';
      }

      function applyFixMore() {
          const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
          if (selectedCheckboxes.length === 0) {
              showModalMessage('Please select at least one checkbox before applying the fix.');
              return;
          }
          const classDescriptions = selectedCheckboxes.map(checkbox => ({
              className: checkbox.getAttribute('data-category'),
              description: checkbox.getAttribute('data-description')
          }));

          const modal = document.getElementById('progressModal');
          const modalContent = document.getElementById('progressModalContent');
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');

          const closeButton = document.createElement('span');
          closeButton.innerHTML = '&times;';
          closeButton.style.cssText = 'position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;';
          closeButton.onclick = () => {
              modal.style.display = 'none';
          };
          modalContent.insertBefore(closeButton, modalContent.firstChild);

          modal.style.display = 'block';
          progressBar.style.width = '0%';
          progressText.textContent = 'Request getting Processed...\n';

          let displayedEvents = new Set();

          const updateProgressText = (events) => {
              events.forEach(event => {
                  if (!displayedEvents.has(event)) {
                      progressText.textContent += event + '\n';
                      displayedEvents.add(event);
                  }
              });
          };

          fetch('/sonar/issue/apply-fix', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(classDescriptions)
          })
          .then(response => response.json())
          .then(data => {
              if (!data.operationId) {
                  throw new Error('operationId not found.');
              }
              const operationId = data.operationId;
              let progress = 0;
              const interval = setInterval(() => {
                  fetch('/sonar/issue/fix-status/' + operationId)
                      .then(response => {
                          if (response.ok) return response.json();
                          throw new Error('Error ' + response.status + ': ' + response.statusText);
                      })
                      .then(statusData => {
                          const events = statusData.step;
                          updateProgressText(events);
                          progress += 16;
                          progressBar.style.width = Math.min(progress, 100) + '%';
                          if (events.some(event => event.includes('Completed'))) {
                              clearInterval(interval);
                              updateProgressText(['Fix applied successfully!']);
                          }
                          if (events.some(event => event.includes("Failed"))) {
                              clearInterval(interval);
                              updateProgressText(["There was an error applying the fix."]);
                          }
                      })
                      .catch(error => {
                          console.error('Error:', error);
                          updateProgressText(['Error: ' + error.message]);
                          clearInterval(interval);
                      });
              }, 250);
          })
          .catch(error => {
              console.error('Error:', error);
              updateProgressText(['Error: ' + error.message]);
          });
      }

      function applyFix(linkElement, className, description) {
          const selectedCheckboxes = Array.from(document.querySelectorAll('.issue-checkbox')).filter(checkbox => checkbox.checked);
          if (selectedCheckboxes.length === 0) {
              showModalMessage('Please select at least one checkbox before applying the fix.');
              return;
          }
          const url = '/sonar/issue/apply-fix/' + encodeURIComponent(className) + '/desc/' + encodeURIComponent(description);
          console.log('Applying fix with URL:', url);

          const modal = document.getElementById('progressModal');
          const modalContent = document.getElementById('progressModalContent');
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');

          const closeButton = document.createElement('span');
          closeButton.innerHTML = '&times;';
          closeButton.style.cssText = 'position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;';
          closeButton.onclick = () => {
              modal.style.display = 'none';
          };
          modalContent.insertBefore(closeButton, modalContent.firstChild);

          modal.style.display = 'block';
          progressBar.style.width = '0%';
          progressText.textContent = 'Starting...\n';

          let displayedEvents = new Set();

          const updateProgressText = (events) => {
              events.forEach(event => {
                  if (!displayedEvents.has(event)) {
                      progressText.textContent += event + '\n';
                      displayedEvents.add(event);
                  }
              });
          };

          linkElement.textContent = 'Processing...';
          linkElement.style.pointerEvents = 'none';

          fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
          })
              .then(response => {
                  if (response.ok) return response.json();
                  throw new Error('Error ' + response.status + ': ' + response.statusText);
              })
              .then(data => {
                  if (!data.operationId) {
                      throw new Error('operationId not found.');
                  }
                  const operationId = data.operationId;
                  let progress = 0;
                  const interval = setInterval(() => {
                      fetch('/sonar/issue/fix-status/' + operationId)
                          .then(response => {
                              if (response.ok) return response.json();
                              throw new Error('Error ' + response.status + ': ' + response.statusText);
                          })
                          .then(statusData => {
                              const events = statusData.step;
                              updateProgressText(events);
                              progress += 16;
                              progressBar.style.width = Math.min(progress, 100) + '%';
                              if (events.some(event => event.includes('Completed'))) {
                                  clearInterval(interval);
                                  linkElement.textContent = 'Fix Applied';
                                  linkElement.style.color = 'green';
                              }
                              if (events.some(event => event.includes("Failed"))) {
                                  clearInterval(interval);
                                  updateProgressText(["There was an error applying the fix."]);
                                  linkElement.textContent = 'Error Applying Fix';
                                  linkElement.style.color = 'red';
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              updateProgressText(['Error: ' + error.message]);
                              clearInterval(interval);
                              linkElement.textContent = 'Apply Fix';
                              linkElement.style.pointerEvents = 'auto';
                          });
                  }, 250);
              })
              .catch(error => {
                  console.error('Error:', error);
                  updateProgressText(['Error: ' + error.message]);
                  linkElement.textContent = 'Apply Fix';
                  linkElement.style.pointerEvents = 'auto';
              });
      }

      function showModalMessage(message) {
          const modal = document.getElementById('progressModal');
          const modalContent = document.getElementById('progressModalContent');
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');

          const closeButton = document.createElement('span');
          closeButton.innerHTML = '&times;';
          closeButton.style.cssText = 'position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;';
          closeButton.onclick = () => {
              modal.style.display = 'none';
          };
          modalContent.insertBefore(closeButton, modalContent.firstChild);

          modal.style.display = 'block';
          progressBar.style.width = '0%';
          progressText.textContent = message;
      }

      searchButton.addEventListener('click', filterTable);
      searchInput.addEventListener('input', filterTable);

      // Initial pagination setup
      paginateTable(1, 10);
  });
</script>
</body>
</html>